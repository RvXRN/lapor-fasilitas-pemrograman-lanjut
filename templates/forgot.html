{% extends "base.html" %}
{% block title %}Lupa Password{% endblock %}
{% block content %}
<div class="forgot-container">
    <div class="forgot-card">
        <div class="card-header text-center text-white">
            <h2 class="login-title mb-0">
                <i class="bi bi-lock-fill me-2"></i> Lupa Password
            </h2>
        </div>
        <div class="card-body">
            <!-- Pesan sukses muncul di sini -->
            <div id="notifSuccess"></div>

            <form id="forgotForm" method="POST">
                <div class="mb-3">
                    <label for="email" class="form-label fw-semibold">
                        Email <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="email" 
                        class="form-control"
                        id="email" 
                        name="email" 
                        placeholder="Masukkan email Anda"
                        required
                    >
                </div>
                <div class="mb-3">
                    <label for="no_telp" class="form-label fw-semibold">
                        No. Telepon <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="tel" 
                        class="form-control"
                        id="no_telp"
                        name="no_telp"
                        placeholder="Contoh: 081234567890"
                        required
                    >
                </div>
                <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold mb-2" id="submitBtn">
                    <i class="bi bi-envelope-arrow-up"></i> Kirim Reset Link
                </button>
                <!-- Pilihan pengiriman, awalnya disembunyikan -->
                <div id="deliveryChoice" style="display:none; margin-top:8px;">
                    <label class="fw-semibold mb-2">Kirim link melalui:</label>
                    <div class="d-flex justify-content-center gap-3 mt-2">
                        <button type="button" class="btn btn-outline-primary" id="emailBtn" onclick="handleChoice('email')">
                            <i class="bi bi-envelope"></i> Email
                        </button>
                        <button type="button" class="btn btn-outline-success" id="smsBtn" onclick="handleChoice('sms')">
                            <i class="bi bi-chat-dots"></i> SMS
                        </button>
                    </div>
                    <div id="timerSMS" class="mt-2 fw-semibold text-warning"></div>
                </div>

                <!-- Hasil link reset tampil di sini -->
                <div id="resetLinkResult" class="mt-4"></div>
            </form>
        </div>
        <div class="card-footer text-center">
            <p class="mb-0 text-muted">
                Ingat Password? <a href="{{ url_for('login') }}" class="text-success fw-semibold">Login di sini</a>
            </p>
        </div>
    </div>
</div>

<script>
let smsTimeout = null;
let timerInterval = null;
document.getElementById('forgotForm').addEventListener('submit', function(e){
    e.preventDefault();
    document.getElementById('deliveryChoice').style.display = 'block';
    document.getElementById('emailBtn').disabled = false;
    document.getElementById('smsBtn').disabled = false;
    document.getElementById('timerSMS').textContent = '';
    var resetLinkResult = document.getElementById('resetLinkResult');
    resetLinkResult.innerHTML = "";
    document.getElementById('notifSuccess').innerHTML = "";
    if (smsTimeout) {
        clearTimeout(smsTimeout);
        smsTimeout = null;
    }
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
});

function handleChoice(method) {
    var email = document.getElementById('email').value;
    var no_telp = document.getElementById('no_telp').value;
    var resetLinkResult = document.getElementById('resetLinkResult');
    var emailBtn = document.getElementById('emailBtn');
    var smsBtn = document.getElementById('smsBtn');
    var submitBtn = document.getElementById('submitBtn'); // Ambil tombol submit di sini
    var notifSuccess = document.getElementById('notifSuccess');

    emailBtn.disabled = true;
    smsBtn.disabled = true;
    submitBtn.disabled = true; // Disable tombol submit setelah Email/SMS dipilih

    // AJAX POST ke /forgot_generate_link
    fetch("/forgot_generate_link", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({email: email, no_telp: no_telp, method: method})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let pesanSukses = (method === 'email')
                ? `Berhasil mengirimkan link reset password ke <b>${email}</b>`
                : `Berhasil mengirimkan link reset password ke <b>${no_telp}</b>`;
            notifSuccess.innerHTML =
                `<div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
                    ${pesanSukses}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
                        onclick="document.getElementById('notifSuccess').innerHTML = ''"></button>
                </div>`;

            resetLinkResult.innerHTML =
                `<div class="reset-link-box">
                    <span class="fw-semibold">Klik untuk reset password:</span><br>
                    <a href="${data.reset_link}">${data.reset_link}</a>
                </div>`;
        } else {
            notifSuccess.innerHTML = '';
            resetLinkResult.innerHTML = `<span class="text-danger">${data.message}</span>`;
        }
    })
    .catch(() => {
        notifSuccess.innerHTML = '';
        resetLinkResult.innerHTML = '<span class="text-danger">Terjadi kesalahan jaringan/server.</span>';
    });
}
</script>
{% endblock %}
